<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimatum Game - Modificado</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --primary-color: #4a90e2; /* Azul brillante */
            --secondary-color: #50e3c2; /* Verde menta */
            --accent-color-blue: #2c3e50;
            --accent-color-green: #283a34;
            --border-highlight: #50e3c2;
            --reject-color: #e74c3c;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --transition-speed: 0.3s;
        }

        html, body {
            height: 100%;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            overscroll-behavior: none;
        }

        .screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
            text-align: center;
            opacity: 0;
            transform: scale(0.98);
            transition: opacity var(--transition-speed) ease-in-out, transform var(--transition-speed) ease-in-out;
            position: absolute;
            width: 100%;
            top: 0;
            left: 0;
        }

        .screen.active {
            opacity: 1;
            transform: scale(1);
            z-index: 1;
        }

        .hidden {
            display: none;
            z-index: -1;
        }

        h1, h2, h3 {
            font-weight: 300;
            letter-spacing: 1px;
        }

        h1 { font-size: 2.5rem; }
        h2 { font-size: 2rem; }

        /* --- Pantalla de Configuración e Inicio --- */
        #setupScreen .container, #resultsScreen .container {
            max-width: 800px;
            width: 100%;
            background-color: rgba(40, 40, 40, 0.6);
            padding: 2rem 3rem;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .theory-box {
            text-align: left;
            margin-bottom: 2rem;
            padding-left: 1rem;
            border-left: 2px solid var(--primary-color);
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .theory-box p { margin: 0.5rem 0; }
        .theory-box strong { color: var(--secondary-color); font-weight: 500;}

        .setup-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .input-group label {
            font-size: 1.2rem;
        }

        .input-group input {
            font-size: 1.2rem;
            padding: 0.5rem;
            width: 80px;
            text-align: center;
            background-color: #333;
            color: var(--text-color);
            border: 1px solid #555;
            border-radius: 6px;
        }

        .main-button {
            padding: 1rem 2rem;
            font-size: 1.2rem;
            font-weight: 500;
            color: #fff;
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color var(--transition-speed), transform var(--transition-speed);
        }

        .main-button:hover {
            background-color: #5a9ee4;
            transform: translateY(-2px);
        }

        /* --- Pantalla de Experimento --- */
        #experimentScreen {
            flex-direction: row;
            height: 100vh;
            width: 100vw;
            padding: 0;
        }

        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            position: relative;
            transition: background-color var(--transition-speed);
        }

        .interviewer-panel { background-color: var(--accent-color-blue); }
        .participant-panel { background-color: var(--accent-color-green); }

        .panel-title {
            position: absolute;
            top: 2rem;
            font-size: 1.5rem;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .trial-counter {
            position: absolute;
            top: 2rem;
            left: 2rem;
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .option-button, .response-button {
            min-height: 120px;
            min-width: 250px;
            padding: 1rem;
            font-size: 2.5rem;
            font-weight: bold;
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            color: var(--text-color);
            background-color: rgba(255, 255, 255, 0.1);
            transition: all var(--transition-speed);
        }
        
        .option-button:hover, .response-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.03);
        }

        .option-button.selected {
            border-color: var(--border-highlight);
            box-shadow: 0 0 20px var(--border-highlight);
            transform: scale(1.05);
        }

        .participant-question {
            font-size: 2.5rem;
            margin-bottom: 2rem;
        }

        .response-container {
            display: flex;
            gap: 1.5rem;
        }

        .response-button.accept { background-color: rgba(80, 227, 194, 0.3); }
        .response-button.reject { background-color: rgba(231, 76, 60, 0.3); }

        .response-hint {
            position: absolute;
            bottom: 2rem;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            width: 100%;
        }

        /* --- Pantalla de Resultados --- */
        #resultsScreen h1 {
            margin-bottom: 2rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem 4rem;
            width: 100%;
            margin-bottom: 3rem;
        }
        
        .result-item {
            text-align: left;
        }

        .result-item h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.3rem;
            color: var(--primary-color);
        }

        .scale-container {
            margin-top: 0.5rem;
        }

        .scale-bar {
            width: 100%;
            height: 8px;
            background: linear-gradient(to right, #333, #777);
            border-radius: 4px;
            position: relative;
            margin-top: 0.5rem;
        }

        .scale-marker {
            width: 16px;
            height: 16px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px var(--secondary-color);
        }
        
        .scale-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 0.5rem;
        }

        .interpretation-box {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: rgba(0,0,0,0.2);
            border-radius: 8px;
            border-left: 3px solid var(--secondary-color);
        }
        
        .interpretation-box h3 {
            margin-top: 0;
            color: var(--secondary-color);
        }

        .download-button {
            margin-top: 2rem;
        }

    </style>
</head>
<body>

    <!-- Pantalla 1: Configuración e Introducción -->
    <div id="setupScreen" class="screen active">
        <div class="container">
            <h1>Juego del Ultimátum</h1>
            <div class="theory-box">
                <p>Este experimento se basa en la investigación sobre la toma de decisiones, la justicia y la intención.</p>
                <p><strong>Referencias clave:</strong></p>
                <ul>
                    <li><strong>Fehr & Schmidt (1999):</strong> Modelo de aversión a la inequidad, que introduce el parámetro <strong>α</strong> (alfa) para medir la sensibilidad a la desigualdad en desventaja. Un <strong>α</strong> alto indica un fuerte rechazo a resultados donde uno recibe menos que el otro.</li>
                    <li><strong>Falk, Fehr & Fischbacher (2003):</strong> Demostraron que la intención detrás de una oferta importa. El parámetro <strong>γ</strong> (gamma) estima esta sensibilidad, midiendo cómo cambia la tasa de rechazo cuando el proponente tenía una alternativa justa disponible pero eligió no ofrecerla.</li>
                </ul>
            </div>
            <div class="setup-controls">
                <div class="input-group">
                    <label for="totalTrials">Número total de ensayos:</label>
                    <input type="number" id="totalTrials" value="48" min="24" max="96" step="12">
                </div>
                <button id="startButton" class="main-button">Iniciar Experimento</button>
            </div>
        </div>
    </div>

    <!-- Pantalla 2: Experimento -->
    <div id="experimentScreen" class="screen hidden">
        <div class="panel interviewer-panel">
            <h2 class="panel-title">ENTREVISTADOR</h2>
            <div id="trialCounter" class="trial-counter"></div>
            <div id="interviewerOptions" class="options-container">
                <!-- Botones de opción se generan aquí -->
            </div>
        </div>
        <div class="panel participant-panel">
            <h2 class="panel-title">PARTICIPANTE</h2>
            <div id="participantResponse" class="hidden">
                <h3 class="participant-question">¿Lo aceptas?</h3>
                <div class="response-container">
                    <button id="acceptButton" class="response-button accept">ACEPTAR</button>
                    <button id="rejectButton" class="response-button reject">RECHAZAR</button>
                </div>
                <div id="responseHint" class="response-hint"></div>
            </div>
        </div>
    </div>

    <!-- Pantalla 3: Resultados -->
    <div id="resultsScreen" class="screen hidden">
        <div class="container">
            <h1>Resultados del Experimento</h1>
            <div class="results-grid">
                <div class="result-item">
                    <h3>α (Sensibilidad a Inequidad)</h3>
                    <p>Valor estimado: <strong id="alphaValue"></strong> (<span id="alphaCategory"></span>)</p>
                    <div class="scale-container">
                         <div class="scale-bar">
                            <div id="alphaMarker" class="scale-marker"></div>
                        </div>
                        <div class="scale-labels">
                            <span>Baja</span>
                            <span>Alta</span>
                        </div>
                    </div>
                </div>
                <div class="result-item">
                    <h3>γ (Sensibilidad a Intención)</h3>
                    <p>Valor estimado: <strong id="gammaValue"></strong> (<span id="gammaCategory"></span>)</p>
                     <div class="scale-container">
                        <div class="scale-bar">
                            <div id="gammaMarker" class="scale-marker"></div>
                        </div>
                        <div class="scale-labels">
                            <span>Baja</span>
                            <span>Alta</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="interpretationBox" class="interpretation-box">
                <h3>Interpretación del Patrón</h3>
                <p id="interpretationText"></p>
            </div>

            <button id="downloadButton" class="main-button download-button">Descargar Datos (CSV)</button>
        </div>
    </div>

    <script>
        // Lógica completa del experimento
        document.addEventListener('DOMContentLoaded', () => {

            // --- VARIABLES GLOBALES Y DE ESTADO ---
            let totalTrials = 48;
            let currentTrial = 0;
            let trialData = [];
            let experimentPlan = [];
            let startTime;

            // --- DOM ELEMENTS ---
            const screens = {
                setup: document.getElementById('setupScreen'),
                experiment: document.getElementById('experimentScreen'),
                results: document.getElementById('resultsScreen'),
            };
            const totalTrialsInput = document.getElementById('totalTrials');
            const startButton = document.getElementById('startButton');
            const trialCounter = document.getElementById('trialCounter');
            const interviewerOptions = document.getElementById('interviewerOptions');
            const participantResponse = document.getElementById('participantResponse');
            const acceptButton = document.getElementById('acceptButton');
            const rejectButton = document.getElementById('rejectButton');
            const responseHint = document.getElementById('responseHint');
            const downloadButton = document.getElementById('downloadButton');

            // --- LÓGICA DE TRANSICIÓN DE PANTALLAS ---
            const switchScreen = (screenName) => {
                // Primero, sal del modo de pantalla completa si estamos saliendo del experimento
                if (screenName !== 'experiment' && document.fullscreenElement) {
                    document.exitFullscreen();
                }

                Object.values(screens).forEach(screen => {
                    screen.classList.add('hidden');
                    screen.classList.remove('active');
                });
                screens[screenName].classList.remove('hidden');
                
                // Forzar reflujo para reiniciar la animación
                void screens[screenName].offsetWidth;
                
                screens[screenName].classList.add('active');

                // Entrar en modo de pantalla completa para el experimento
                if (screenName === 'experiment') {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.warn(`Error al intentar entrar en pantalla completa: ${err.message}`);
                    });
                }
            };
            
            // --- LÓGICA DE GENERACIÓN DE ENSAYOS ---
            /**
             * Baraja un array in-place usando el algoritmo Fisher-Yates.
             * @param {Array} array - El array a barajar.
             */
            const shuffleArray = (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            };

            const generateExperimentPlan = () => {
                totalTrials = parseInt(totalTrialsInput.value, 10);
                // Asegurar que el número es divisible por 12 para mantener proporciones exactas fácilmente
                if (totalTrials % 12 !== 0) {
                    totalTrials = Math.round(totalTrials / 12) * 12;
                    totalTrialsInput.value = totalTrials;
                }
                
                const baseProportions = { '5/5': 6, '6/4': 12, '8/2': 18, '9/1': 12 };
                const baseTotal = 48;
                
                experimentPlan = [];
                for (const offer in baseProportions) {
                    const count = Math.round((baseProportions[offer] / baseTotal) * totalTrials);
                    for (let i = 0; i < count; i++) {
                        const hasFairAlternative = (i < count / 2);
                        experimentPlan.push({
                            offerType: offer,
                            hasFairAlternative: hasFairAlternative,
                            intention: hasFairAlternative ? 1 : 0
                        });
                    }
                }

                shuffleArray(experimentPlan); // Barajar el plan de ensayos
            };

            // --- LÓGICA DEL EXPERIMENTO ---
            const startExperiment = () => {
                generateExperimentPlan();
                currentTrial = 0;
                trialData = [];
                switchScreen('experiment');
                nextTrial();
            };

            const nextTrial = () => {
                if (currentTrial >= totalTrials) {
                    endExperiment();
                    return;
                }

                participantResponse.classList.add('hidden');
                interviewerOptions.innerHTML = '';

                const trial = experimentPlan[currentTrial];
                trialCounter.textContent = `Ensayo: ${currentTrial + 1} / ${totalTrials}`;

                let options = [];
                if (trial.hasFairAlternative) {
                    options = ['5/5', trial.offerType];
                } else {
                    options = [trial.offerType];
                }

                // Barajar las opciones si hay dos
                if(options.length > 1) {
                    shuffleArray(options);
                }

                options.forEach(opt => {
                    const button = document.createElement('button');
                    button.className = 'option-button';
                    button.textContent = opt;
                    button.dataset.offer = opt;
                    button.addEventListener('click', handleInterviewerChoice, { once: true });
                    button.addEventListener('touchstart', handleInterviewerChoice, { once: true });
                    interviewerOptions.appendChild(button);
                });
            };

            const handleInterviewerChoice = (e) => {
                e.preventDefault();
                const chosenButton = e.currentTarget;
                const chosenOffer = chosenButton.dataset.offer;

                // Marcar la opción seleccionada
                document.querySelectorAll('.option-button').forEach(btn => {
                    btn.removeEventListener('click', handleInterviewerChoice);
                    btn.removeEventListener('touchstart', handleInterviewerChoice);
                    if (btn === chosenButton) {
                        btn.classList.add('selected');
                    }
                });

                // Registrar datos preliminares
                const [y, x] = chosenOffer.split('/').map(Number); // y = Entrevistador, x = Participante
                const currentTrialData = {
                    trialNumber: currentTrial + 1,
                    offerType: experimentPlan[currentTrial].offerType,
                    chosenOffer: chosenOffer,
                    inequityValue: y - x,
                    intention: experimentPlan[currentTrial].intention,
                };

                setTimeout(() => {
                    chosenButton.classList.remove('selected');
                    showParticipantResponse(currentTrialData, x, y);
                }, 500);
            };

            const showParticipantResponse = (currentTrialData, participantGain, interviewerGain) => {
                participantResponse.classList.remove('hidden');

                if (currentTrial < 10) {
                    responseHint.innerHTML = `
                        Bajo ACEPTAR: Tú ganas ${participantGain} € – Entrevistador gana ${interviewerGain} €<br>
                        Bajo RECHAZAR: Ambos ganáis 0 €
                    `;
                } else {
                    responseHint.innerHTML = '';
                }

                startTime = performance.now();
                
                const handleResponse = (e) => {
                    e.preventDefault();
                    acceptButton.removeEventListener('click', handleResponse);
                    acceptButton.removeEventListener('touchstart', handleResponse);
                    rejectButton.removeEventListener('click', handleResponse);
                    rejectButton.removeEventListener('touchstart', handleResponse);
                    
                    const reactionTime = performance.now() - startTime;
                    const response = e.currentTarget.id === 'acceptButton' ? 'accept' : 'reject';
                    
                    trialData.push({
                        ...currentTrialData,
                        response,
                        reactionTime: parseFloat(reactionTime.toFixed(2)),
                    });

                    currentTrial++;
                    nextTrial();
                };

                acceptButton.addEventListener('click', handleResponse, { once: true });
                acceptButton.addEventListener('touchstart', handleResponse, { once: true });
                rejectButton.addEventListener('click', handleResponse, { once: true });
                rejectButton.addEventListener('touchstart', handleResponse, { once: true });
            };

            // --- LÓGICA DE FIN DE EXPERIMENTO Y RESULTADOS ---
            const endExperiment = () => {
                calculateResults();
                switchScreen('results');
            };

            const calculateResults = () => {
                // 7.1 Cálculo de α (alfa)
                const unfairOffers = trialData.filter(d => d.chosenOffer !== '5/5');
                const rejectionThresholds = {
                    '9/1': 1/8, // 0.125
                    '8/2': 2/6, // 0.333
                    '6/4': 4/2  // 2.0
                };
                
                let alphaEstimate = 0;
                const rejectedOffers = unfairOffers.filter(d => d.response === 'reject');
                
                if (rejectedOffers.length > 0) {
                    // Estimar α basado en el umbral más bajo rechazado consistentemente
                    const rejectedOfferTypes = new Set(rejectedOffers.map(d => d.chosenOffer));
                    const criticalValues = Array.from(rejectedOfferTypes).map(offer => rejectionThresholds[offer]);
                    if (criticalValues.length > 0) {
                       alphaEstimate = Math.min(...criticalValues);
                    }
                }
                
                // Para una visualización más continua, si se rechazan ofertas muy injustas, se puede promediar
                const rejected82 = rejectedOffers.filter(d => d.chosenOffer === '8/2').length / trialData.filter(d => d.chosenOffer === '8/2').length > 0.5;
                const rejected64 = rejectedOffers.filter(d => d.chosenOffer === '6/4').length / trialData.filter(d => d.chosenOffer === '6/4').length > 0.5;

                if (rejected64) alphaEstimate = 2.0;
                else if (rejected82) alphaEstimate = 0.33;
                
                const alpha = parseFloat(alphaEstimate.toFixed(2));


                // 7.2 Cálculo de γ (gamma)
                const withIntention = trialData.filter(d => d.intention === 1 && d.chosenOffer !== '5/5');
                const withoutIntention = trialData.filter(d => d.intention === 0 && d.chosenOffer !== '5/5');
                
                const rejectionRateWithIntention = withIntention.length > 0 ? withIntention.filter(d => d.response === 'reject').length / withIntention.length : 0;
                const rejectionRateWithoutIntention = withoutIntention.length > 0 ? withoutIntention.filter(d => d.response === 'reject').length / withoutIntention.length : 0;
                
                const gamma = parseFloat((rejectionRateWithIntention - rejectionRateWithoutIntention).toFixed(2));

                displayResults(alpha, gamma);
            };

            const displayResults = (alpha, gamma) => {
                // Categorías
                let alphaCategory, gammaCategory;
                if (alpha < 0.3) alphaCategory = "Baja";
                else if (alpha <= 1.5) alphaCategory = "Típica";
                else alphaCategory = "Alta";

                if (gamma < 0.1) gammaCategory = "Baja";
                else if (gamma <= 0.35) gammaCategory = "Típica";
                else gammaCategory = "Alta";

                // Valores
                document.getElementById('alphaValue').textContent = alpha;
                document.getElementById('alphaCategory').textContent = alphaCategory;
                document.getElementById('gammaValue').textContent = gamma;
                document.getElementById('gammaCategory').textContent = gammaCategory;

                // Marcadores en la escala
                const alphaMarker = document.getElementById('alphaMarker');
                const gammaMarker = document.getElementById('gammaMarker');
                // Escala de Alpha (0 a 3, para visualización)
                alphaMarker.style.left = `${Math.min(100, (alpha / 3) * 100)}%`;
                // Escala de Gamma (-1 a 1, normalizado a 0-100%)
                gammaMarker.style.left = `${((gamma + 1) / 2) * 100}%`;
                
                // Interpretación de patrones
                let interpretation = "";
                if (alphaCategory === "Alta" && gammaCategory === "Baja") {
                    interpretation = "Rigidez estructural: La respuesta se guía por una regla estricta de justicia (ej. 'nunca acepto menos de X') más que por la intención del otro.";
                } else if (alphaCategory === "Baja" && gammaCategory === "Baja") {
                    interpretation = "Utilitarismo / Bajo peso moral: La decisión se centra principalmente en maximizar el beneficio propio, con poca influencia de la equidad o la intención.";
                } else if (alphaCategory !== "Alta" && gammaCategory === "Alta") {
                    interpretation = "Sensibilidad interpersonal: La reacción está fuertemente influenciada por la percepción de la intención del otro, castigando las elecciones injustas cuando había alternativas justas.";
                } else if (alphaCategory === "Alta" && gammaCategory === "Alta") {
                    interpretation = "Fuerte normatividad y mentalización: Indica una alta sensibilidad tanto a la norma de equidad como a la intención del proponente, sugiriendo un procesamiento social complejo.";
                } else {
                    interpretation = "Patrón mixto: La toma de decisiones parece ser un balance entre la sensibilidad a la equidad y la percepción de la intención del otro.";
                }
                document.getElementById('interpretationText').textContent = interpretation;
            };

            // --- LÓGICA DE EXPORTACIÓN ---
            const downloadCSV = () => {
                let csvContent = "data:text/csv;charset=utf-8,";
                
                // Resumen
                const alpha = document.getElementById('alphaValue').textContent;
                const gamma = document.getElementById('gammaValue').textContent;
                csvContent += "parametro,valor\n";
                csvContent += `alpha_estimado,${alpha}\n`;
                csvContent += `gamma_estimado,${gamma}\n\n`;

                // Datos por trial
                const headers = Object.keys(trialData[0]).join(',');
                csvContent += headers + '\n';
                trialData.forEach(row => {
                    const values = Object.values(row).join(',');
                    csvContent += values + '\n';
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `ultimatum_game_data_${new Date().toISOString()}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- EVENT LISTENERS ---
            startButton.addEventListener('click', startExperiment);
            downloadButton.addEventListener('click', downloadCSV);
        });
    </script>
</body>
</html>
