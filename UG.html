<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimatum Game - Experimento</title>
    <style>
        :root {
            --color-background: #1a1a1a;
            --color-surface: #2c2c2c;
            --color-text: #e0e0e0;
            --color-text-muted: #9e9e9e;
            --color-primary: #58a6ff;
            --color-primary-glow: rgba(88, 166, 255, 0.5);
            --color-accept: #3fb950;
            --color-reject: #f85149;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body, html {
            height: 100%;
            margin: 0;
            background-color: var(--color-background);
            color: var(--color-text);
            font-family: var(--font-main);
        }

        .container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            padding: 20px;
        }

        .screen { display: none; }
        .screen.active { 
            display: flex; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* --- Pantalla de Configuraci√≥n y Resultados --- */
        .card-screen {
            background-color: var(--color-surface);
            padding: 30px 40px;
            border-radius: 12px;
            border: 1px solid #444;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .card-screen h1 { 
            margin-top: 0; 
            color: var(--color-primary);
            border-bottom: 1px solid #444;
            padding-bottom: 15px;
            margin-bottom: 25px;
            text-align: center;
        }

        .theory-box {
            text-align: left;
            background-color: #333;
            border-left: 4px solid var(--color-primary);
            padding: 15px 20px;
            margin: 25px 0;
            border-radius: 4px;
        }
        .theory-box ul { padding-left: 20px; }

        .config-box {
            margin: 30px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        .config-box input {
            width: 80px;
            padding: 10px;
            font-size: 1.1em;
            text-align: center;
            border: 1px solid #555;
            border-radius: 5px;
            background-color: #333;
            color: var(--color-text);
        }

        .main-button {
            width: 100%;
            padding: 15px 30px;
            font-size: 1.2em;
            cursor: pointer;
            border: none;
            background-color: var(--color-primary);
            color: var(--color-background);
            border-radius: 8px;
            transition: background-color 0.3s, transform 0.2s;
            font-weight: bold;
        }
        .main-button:hover { background-color: #79bbff; transform: translateY(-2px); }

        /* --- Pantalla de Experimento --- */
        #experiment-screen {
            flex-direction: row;
            gap: 10px;
        }
        .panel {
            flex: 1;
            height: calc(100vh - 40px);
            padding: 20px;
            background-color: var(--color-surface);
            border: 1px solid #444;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        .panel h2 {
            font-size: 1.8em;
            margin-top: 0;
            color: var(--color-text-muted);
            width: 100%;
            text-align: center;
            padding-bottom: 5px;
            margin-bottom: 5px;
        }
        
        .panel .subtitle {
            font-size: 1.2em;
            color: var(--color-text);
            margin-bottom: 20px;
        }

        #trial-counter {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1.1em;
            color: var(--color-text-muted);
        }

        .options-container, .response-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
            width: 100%;
            flex-grow: 1;
        }

        .option-button {
            width: 80%;
            max-width: 400px;
            min-height: 120px;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid #555;
            background-color: #3a3a3a;
            color: var(--color-text);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.2s;
            user-select: none;
            position: relative;
        }
        .option-button:hover { border-color: var(--color-primary); }

        .option-button .main-offer { font-size: 2.5em; }
        .option-button .offer-hint { font-size: 0.9em; color: var(--color-text-muted); margin-top: 8px; }

        .option-button.selected {
            border-color: var(--color-primary);
            box-shadow: 0 0 20px var(--color-primary-glow);
            cursor: not-allowed;
        }
        .option-button.selected:hover { transform: none; }

        .response-option {
            width: 80%;
            max-width: 400px;
            min-height: 120px;
            cursor: pointer;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s;
            padding: 15px;
            box-sizing: border-box;
        }
        .response-option:hover { transform: translateY(-3px); }

        #accept-btn { border: 2px solid var(--color-accept); color: var(--color-accept); }
        #reject-btn { border: 2px solid var(--color-reject); color: var(--color-reject); }

        #accept-btn:hover { background-color: rgba(63, 185, 80, 0.1); }
        #reject-btn:hover { background-color: rgba(248, 81, 73, 0.1); }
        
        .response-option .label { font-size: 2.2em; font-weight: bold; }
        .response-hint {
            font-size: 1.1em;
            color: var(--color-text-muted);
            margin-top: 10px;
            text-align: center;
            line-height: 1.4;
            visibility: hidden;
        }
        .response-hint.visible { visibility: visible; }

        #participant-question {
            font-size: 2em;
            font-weight: bold;
            color: var(--color-text);
            margin-bottom: 20px;
            visibility: hidden;
            animation: fadeIn 0.5s;
        }
        #participant-question.visible { visibility: visible; }

        #response-buttons { width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px; visibility: hidden; }
        #response-buttons.visible { visibility: visible; }

        /* --- Resultados --- */
        .result-summary, .result-interpretation, .result-visualization {
            width: 100%;
            margin-bottom: 30px;
        }
        .result-summary h2, .result-interpretation h2, .result-visualization h2 {
            color: var(--color-text);
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .result-item { font-size: 1.3em; margin: 15px 0; }
        .result-item span { font-weight: bold; color: var(--color-primary); }
        
        .visual-scale { margin: 25px 0; }
        .visual-scale .label { font-weight: bold; font-size: 1.1em; margin-bottom: 10px; }
        .scale-bar-container { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .scale-bar { flex-grow: 1; height: 10px; background: linear-gradient(to right, #555, #999); border-radius: 10px; position: relative; }
        .scale-marker { width: 18px; height: 18px; background-color: var(--color-primary); border-radius: 50%; border: 2px solid var(--color-background); position: absolute; top: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        
        .interpretation-box { background-color: #333; border-radius: 8px; padding: 20px; }
        .interpretation-box h3 { margin-top: 0; color: var(--color-primary); }
        .interpretation-box p { font-size: 1em; line-height: 1.5; color: var(--color-text-muted); }
    </style>
</head>
<body>

<div id="main-container" class="container">

    <!-- Pantalla 1: Configuraci√≥n inicial -->
    <div id="setup-screen" class="screen active card-screen">
        <h1>Experimento: Juego del Ultim√°tum</h1>
        <div class="theory-box">
             <!-- Contenido te√≥rico sin cambios -->
        </div>
        <div class="config-box">
            <label for="total-trials-input">N√∫mero de ensayos:</label>
            <input type="number" id="total-trials-input" value="48" min="24" max="96" step="12">
        </div>
        <button id="start-experiment" class="main-button">Iniciar experimento</button>
    </div>

    <!-- Pantalla 2: Transici√≥n para iniciar -->
    <div id="start-task-screen" class="screen">
        <h1 style="font-size: 3em;">El experimento va a comenzar</h1>
    </div>

    <!-- Pantalla 3: Experimento en curso -->
    <div id="experiment-screen" class="screen">
        <div class="panel">
            <div id="trial-counter"></div>
            <h2>ENTREVISTADOR</h2>
            <div class="subtitle">Reparto 10‚Ç¨ üí∂</div>
            <div id="interviewer-options" class="options-container">
                <!-- Opciones generadas por JS -->
            </div>
        </div>
        <div class="panel">
            <h2>PARTICIPANTE</h2>
            <div class="response-container">
                <div id="participant-question">¬øAceptas la oferta?</div>
                <div id="response-buttons">
                    <div id="accept-btn" class="response-option">
                        <span class="label">ACEPTAR</span>
                        <div id="accept-hint" class="response-hint"></div>
                    </div>
                    <div id="reject-btn" class="response-option">
                        <span class="label">RECHAZAR</span>
                        <div id="reject-hint" class="response-hint"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla 4: Resultados -->
    <div id="results-screen" class="screen card-screen">
         <h1>Resultados del Experimento</h1>
        <div class="result-summary">
            <h2>M√©tricas Clave</h2>
            <p class="result-item">Œ± (Sensibilidad a Inequidad): <span id="alpha-result"></span></p>
            <p class="result-item">Œ≥ (Sensibilidad a Intenci√≥n): <span id="gamma-result"></span></p>
        </div>

        <div class="result-visualization">
            <h2>Perfil de Decisi√≥n</h2>
            <div class="visual-scale">
                <div class="label">Sensibilidad a la INEQUIDAD</div>
                <div class="scale-bar-container">
                    <span>Baja</span>
                    <div class="scale-bar"><div id="alpha-marker" class="scale-marker"></div></div>
                    <span>Alta</span>
                </div>
            </div>
            <div class="visual-scale">
                <div class="label">Sensibilidad a la INTENCI√ìN</div>
                <div class="scale-bar-container">
                    <span>Baja</span>
                    <div class="scale-bar"><div id="gamma-marker" class="scale-marker"></div></div>
                    <span>Alta</span>
                </div>
            </div>
        </div>

        <div class="result-interpretation">
            <h2>Interpretaci√≥n</h2>
            <div id="interpretation-box" class="interpretation-box">
                <!-- Interpretaci√≥n generada por JS -->
            </div>
        </div>

        <button id="download-csv" class="main-button" style="margin-top: 20px;">Descargar datos (CSV)</button>
    </div>

</div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    let totalTrials = 48;
    let currentTrial = 0;
    let experimentData = [];
    let trialList = [];
    let reactionStartTime;

    const dom = {
        mainContainer: document.getElementById('main-container'),
        screens: {
            setup: document.getElementById('setup-screen'),
            startTask: document.getElementById('start-task-screen'),
            experiment: document.getElementById('experiment-screen'),
            results: document.getElementById('results-screen')
        },
        totalTrialsInput: document.getElementById('total-trials-input'),
        startButton: document.getElementById('start-experiment'),
        trialCounter: document.getElementById('trial-counter'),
        interviewerOptions: document.getElementById('interviewer-options'),
        participantQuestion: document.getElementById('participant-question'),
        responseButtons: document.getElementById('response-buttons'),
        acceptBtn: document.getElementById('accept-btn'),
        rejectBtn: document.getElementById('reject-btn'),
        acceptHint: document.getElementById('accept-hint'),
        rejectHint: document.getElementById('reject-hint'),
        downloadCsvBtn: document.getElementById('download-csv')
    };

    dom.totalTrialsInput.addEventListener('change', () => {
        let val = parseInt(dom.totalTrialsInput.value);
        const min = parseInt(dom.totalTrialsInput.min);
        const max = parseInt(dom.totalTrialsInput.max);
        if (val < min) val = min;
        if (val > max) val = max;
        val = Math.round(val / 12) * 12;
        if (val < min) val = min;
        dom.totalTrialsInput.value = val;
    });

    dom.startButton.addEventListener('click', () => {
        totalTrials = parseInt(dom.totalTrialsInput.value);
        trialList = generateTrialList(totalTrials);
        switchToScreen('startTask');
        setTimeout(() => {
            switchToScreen('experiment');
            startNextTrial();
        }, 2500); 
    });

    function switchToScreen(screenName) {
        dom.mainContainer.classList.remove('dark-theme');
        Object.values(dom.screens).forEach(s => s.classList.remove('active'));
        dom.screens[screenName].classList.add('active');
        if (screenName === 'setup' || screenName === 'results') {
            dom.mainContainer.classList.add('dark-theme');
        }
    }

    function generateTrialList(numTrials) {
        const baseProportions = { '5/5': 0.125, '6/4': 0.25, '8/2': 0.375, '9/1': 0.25 };
        let trials = [];

        // Crear ofertas
        for (const offer in baseProportions) {
            const count = Math.round(baseProportions[offer] * numTrials);
            for (let i = 0; i < count; i++) {
                trials.push({ offerType: offer });
            }
        }
        while (trials.length < numTrials) trials.push({ offerType: '8/2' });
        trials = trials.slice(0, numTrials);

        // Balancear intenci√≥n y aleatorizar
        let intentions = new Array(numTrials).fill(0).fill(1, 0, Math.ceil(numTrials / 2));
        shuffleArray(intentions);
        
        trials.forEach((trial, index) => {
            trial.intention = intentions[index];
            const [y, x] = trial.offerType.split('/').map(Number);
            trial.inequityValue = y - x;
        });
        
        shuffleArray(trials);
        return trials;
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function startNextTrial() {
        if (currentTrial >= totalTrials) {
            endExperiment();
            return;
        }

        const trial = trialList[currentTrial];
        dom.trialCounter.textContent = `Ensayo ${currentTrial + 1} / ${totalTrials}`;

        dom.interviewerOptions.innerHTML = '';
        dom.participantQuestion.classList.remove('visible');
        dom.responseButtons.classList.remove('visible');
        
        createInterviewerOptions(trial);
        setupParticipantHints(trial);
    }

    function createInterviewerOptions(trial) {
        const optionsToShow = [];
        const mainOfferEl = createOfferButton(trial.offerType);
        optionsToShow.push(mainOfferEl);

        if (trial.intention === 1 && trial.offerType !== '5/5') {
            const fairAlternativeEl = createOfferButton('5/5');
            optionsToShow.push(fairAlternativeEl);
        }

        shuffleArray(optionsToShow);
        optionsToShow.forEach(el => dom.interviewerOptions.appendChild(el));
    }

    function createOfferButton(offer) {
        const [y, x] = offer.split('/').map(Number);
        const button = document.createElement('div');
        button.className = 'option-button';
        button.dataset.offer = offer;
        button.innerHTML = `
            <span class="main-offer">${offer}</span>
            <span class="offer-hint">Me quedo ${y}‚Ç¨ / Te doy ${x}‚Ç¨</span>
        `;
        button.addEventListener('click', handleInterviewerChoice, { once: true });
        return button;
    }
    
    function setupParticipantHints(trial) {
        const [y, x] = trial.offerType.split('/').map(Number);
        
        if (currentTrial < 10) {
            dom.acceptHint.innerHTML = `T√∫ ganas ${x}‚Ç¨<br>Entrevistador gana ${y}‚Ç¨`;
            dom.rejectHint.innerHTML = `T√∫ ganas 0‚Ç¨<br>Entrevistador gana 0‚Ç¨`;
            dom.acceptHint.classList.add('visible');
            dom.rejectHint.classList.add('visible');
        } else {
            dom.acceptHint.classList.remove('visible');
            dom.rejectHint.classList.remove('visible');
        }
    }


    function handleInterviewerChoice(e) {
        const selectedOption = e.currentTarget;
        const offer = selectedOption.dataset.offer;
        trialList[currentTrial].chosenOffer = offer;

        document.querySelectorAll('.option-button').forEach(opt => {
            opt.removeEventListener('click', handleInterviewerChoice);
            if (opt !== selectedOption) {
                opt.style.opacity = '0.5';
                opt.style.cursor = 'not-allowed';
            }
        });
        
        selectedOption.classList.add('selected');

        setTimeout(() => {
            dom.participantQuestion.classList.add('visible');
            dom.responseButtons.classList.add('visible');
            reactionStartTime = performance.now();

            dom.acceptBtn.addEventListener('click', handleParticipantResponse, { once: true });
            dom.rejectBtn.addEventListener('click', handleParticipantResponse, { once: true });
        }, 750);
    }
    
    function handleParticipantResponse(e) {
        const reactionTime = performance.now() - reactionStartTime;
        const response = e.currentTarget.id === 'accept-btn' ? 'accept' : 'reject';

        const trial = trialList[currentTrial];
        experimentData.push({
            trialNumber: currentTrial + 1,
            offerType: trial.offerType,
            intention: trial.intention,
            chosenOffer: trial.chosenOffer,
            response: response,
            reactionTime: parseFloat(reactionTime.toFixed(2))
        });
        
        currentTrial++;
        startNextTrial();
    }

    function endExperiment() {
        setTimeout(() => {
            const { alpha, gamma, interpretation } = calculateResults();
            displayResults(alpha, gamma, interpretation);
            switchToScreen('results');
        }, 500);
    }
    
    function calculateResults() {
        // Rangos para clasificaci√≥n
        const ranges = {
            alpha: { low: 0.3, high: 1.5 },
            gamma: { low: 0.1, high: 0.35 }
        };

        // Estimaci√≥n de Alpha
        const rejections = experimentData.filter(d => d.response === 'reject' && d.chosenOffer === d.offerType);
        const rejectionRates = {};
        ['9/1', '8/2', '6/4'].forEach(offer => {
            const total = experimentData.filter(d => d.offerType === offer).length;
            const rejected = rejections.filter(d => d.offerType === offer).length;
            rejectionRates[offer] = total > 0 ? rejected / total : 0;
        });
        
        let alpha = 0.1;
        if (rejectionRates['6/4'] > 0.5) alpha = 2.0;
        else if (rejectionRates['8/2'] > 0.5) alpha = 0.9;
        else if (rejectionRates['9/1'] > 0.5) alpha = 0.2;
        
        // Estimaci√≥n de Gamma
        const dataWithIntention = experimentData.filter(d => d.intention === 1 && d.offerType !== '5/5');
        const dataWithoutIntention = experimentData.filter(d => d.intention === 0 && d.offerType !== '5/5');

        const rateWith = dataWithIntention.length > 0 ? dataWithIntention.filter(d => d.chosenOffer === d.offerType && d.response === 'reject').length / dataWithIntention.length : 0;
        const rateWithout = dataWithoutIntention.length > 0 ? dataWithoutIntention.filter(d => d.chosenOffer !== '5/5' && d.response === 'reject').length / dataWithoutIntention.length : 0;
        let gamma = Math.max(0, rateWith - rateWithout);

        // Clasificaci√≥n
        const alphaClass = alpha < ranges.alpha.low ? 'bajo' : (alpha > ranges.alpha.high ? 'alto' : 'medio');
        const gammaClass = gamma < ranges.gamma.low ? 'bajo' : (gamma > ranges.gamma.high ? 'alto' : 'medio');

        // Interpretaci√≥n
        let title = "Perfil de Decisi√≥n Equilibrado";
        let text = "Muestras un balance entre el beneficio propio, la equidad y la evaluaci√≥n de las intenciones del otro. No hay una √∫nica tendencia que domine fuertemente tus decisiones en este contexto.";
        if (alphaClass === 'alto' && gammaClass === 'bajo') {
            title = "Rigidez Estructural";
            text = "Tus decisiones est√°n fuertemente guiadas por una regla de equidad. Rechazas la desigualdad en s√≠ misma, independientemente de si el otro ten√≠a o no alternativas.";
        } else if (alphaClass === 'bajo' && gammaClass === 'bajo') {
            title = "Perfil Utilitario";
            text = "Priorizas la ganancia econ√≥mica. Las consideraciones sobre la justicia de la oferta o las intenciones del proponente tienen un peso menor en tus decisiones.";
        } else if (gammaClass === 'alto' && (alphaClass === 'medio' || alphaClass === 'alto')) {
             title = "Alta Sensibilidad Interpersonal / Mentalizaci√≥n";
            text = "Eres muy sensible a las intenciones detr√°s de las acciones de los dem√°s. El hecho de que alguien tuviera una alternativa justa y eligiera no ofrec√©rtela influye fuertemente en tu decisi√≥n de rechazar, incluso m√°s que la desigualdad de la oferta en s√≠.";
        } else if (alphaClass === 'alto' && gammaClass === 'alto') {
            title = "Fuerte Sentido Normativo";
            text = "Posees un robusto sentido de la justicia, reaccionando tanto a la desigualdad del resultado (norma de equidad) como a la intenci√≥n de violar esa norma (mentalizaci√≥n).";
        }


        return { 
            alpha: parseFloat(alpha.toFixed(2)), 
            gamma: parseFloat(gamma.toFixed(2)),
            interpretation: { title, text }
        };
    }

    function displayResults(alpha, gamma, interpretation) {
        document.getElementById('alpha-result').textContent = alpha;
        document.getElementById('gamma-result').textContent = gamma;

        const alphaPercent = Math.min(100, (alpha / 2.5) * 100);
        const gammaPercent = Math.min(100, (gamma / 0.5) * 100);

        document.getElementById('alpha-marker').style.left = `${alphaPercent}%`;
        document.getElementById('gamma-marker').style.left = `${gammaPercent}%`;

        const interpretationBox = document.getElementById('interpretation-box');
        interpretationBox.innerHTML = `<h3>${interpretation.title}</h3><p>${interpretation.text}</p>`;
    }
    
    dom.downloadCsvBtn.addEventListener('click', () => {
        const { alpha, gamma } = calculateResults();
        let csvContent = "data:text/csv;charset=utf-8,";
        
        csvContent += "Parametro,Valor\r\n";
        csvContent += `alpha_estimado,${alpha}\r\n`;
        csvContent += `gamma_estimado,${gamma}\r\n\r\n`;

        if (experimentData.length > 0) {
            const headers = Object.keys(experimentData[0]).join(',');
            csvContent += headers + '\r\n';
            experimentData.forEach(row => {
                const values = Object.values(row).join(',');
                csvContent += values + '\r\n';
            });
        }

        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", `ultimatum_results_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
});
</script>

</body>
</html>
